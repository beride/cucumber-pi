#!/bin/bash

### BEGIN INIT INFO
# Provides:          xvfb
# Required-Start:    $remote_fs
# Required-Stop:     $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:
### END INIT INFO

DISPLAY="${DISPLAY:-:{{ xvfb.display_id }}}"
XVFB=/usr/bin/Xvfb
XVFBARGS=("$DISPLAY" "-ac")
PIDFILE="/var/run/xvfb-${DISPLAY}.pid"

. /lib/lsb/init-functions

set -e

case "$1" in
    start)
        echo -n "Starting virtual X frame buffer: Xvfb $DISPLAY"
        /sbin/start-stop-daemon --start --quiet --pidfile "$PIDFILE" --make-pidfile --background --exec "$XVFB" -- "${XVFBARGS[@]}"
        echo "."
        ;;
    stop)
        echo -n "Stopping virtual X frame buffer: Xvfb $DISPLAY"
        /sbin/start-stop-daemon --stop --quiet --pidfile "$PIDFILE"
        echo "."
        ;;
    restart)
        "$0" stop
        "$0" start
        ;;
    status)
        status_of_proc -p "$PIDFILE" "$XVFB" xvfb
        exit $? # notreached due to set -e
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit 0
